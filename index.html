<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Emir AI</title>
  <style>
    :root{
      --bg:#343541; --panel:#40414f; --panel2:#202123;
      --text:#ececf1; --muted:#c5c5d2; --border:rgba(255,255,255,.12);
      --green:#19c37d; --radius:14px;
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .top{
      position:sticky;top:0;z-index:10;background:var(--panel2);
      border-bottom:1px solid var(--border); padding:10px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--green),#7aa7ff);
      display:grid;place-items:center;color:#07110a;font-weight:900}
    .brand b{display:block;font-size:14px}
    .brand small{display:block;color:var(--muted);font-size:12px}
    .tools{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      border:1px solid var(--border); background:rgba(255,255,255,.06); color:var(--text);
      border-radius:12px; padding:8px 10px; font-weight:800; cursor:pointer; font-size:13px
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn.green{border-color:rgba(25,195,125,.55); background:rgba(25,195,125,.12)}
    .wrap{max-width:980px;margin:0 auto}
    .chat{padding:16px 14px 130px; min-height:calc(100vh - 56px)}
    .row{display:flex;gap:14px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.06)}
    .row:last-child{border-bottom:none}
    .avatar{
      width:34px;height:34px;border-radius:10px;flex:0 0 auto;display:grid;place-items:center;font-weight:900;
      background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10)
    }
    .avatar.me{background:rgba(122,167,255,.16);border-color:rgba(122,167,255,.35)}
    .avatar.bot{background:rgba(109,70,255,.14);border-color:rgba(109,70,255,.35)}
    .bubble{flex:1;white-space:pre-wrap;word-break:break-word;line-height:1.55;font-size:15px}
    .meta{margin-top:6px;font-size:12px;color:rgba(197,197,210,.85);font-family:var(--mono)}
    .composer{
      position:fixed;left:0;right:0;bottom:0;
      background:linear-gradient(180deg, rgba(52,53,65,0), rgba(52,53,65,.95) 35%, rgba(52,53,65,1));
      padding:14px;
    }
    .composer .inner{
      max-width:980px;margin:0 auto;background:var(--panel);
      border:1px solid var(--border);border-radius:16px;display:flex;gap:10px;
      padding:10px;align-items:flex-end;box-shadow:0 18px 40px rgba(0,0,0,.35)
    }
    textarea{
      flex:1;background:transparent;color:var(--text);border:none;outline:none;
      resize:none;min-height:44px;max-height:160px;font-size:15px;line-height:1.45
    }
    .send{
      background:var(--green);color:#052016;border:none;border-radius:12px;
      padding:10px 14px;font-weight:900;cursor:pointer;min-width:90px
    }
    .send:disabled{opacity:.55;cursor:not-allowed}
    .hintbar{max-width:980px;margin:10px auto 0;display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .chip{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);border-radius:999px;padding:7px 10px;cursor:pointer;user-select:none}
    .chip:hover{background:rgba(255,255,255,.10)}
    .typing{display:inline-flex;gap:6px;align-items:center;color:rgba(236,236,241,.9);font-size:14px}
    .dot{width:6px;height:6px;border-radius:999px;background:rgba(236,236,241,.75);animation:bounce 1s infinite}
    .dot:nth-child(2){animation-delay:.12s}
    .dot:nth-child(3){animation-delay:.24s}
    @keyframes bounce{0%,80%,100%{transform:translateY(0);opacity:.6}40%{transform:translateY(-5px);opacity:1}}
    .kbd{font-family:var(--mono);padding:1px 7px;border-radius:9px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.22)}
  </style>
</head>
<body>
  <div class="top">
    <div class="brand">
      <div class="logo">AI</div>
      <div>
        <b id="brandTitle">Emir AI</b>
        <small id="brandSub">7. sÄ±nÄ±f + gÃ¼nlÃ¼k hayat â€¢ offline (APIâ€™siz)</small>
      </div>
    </div>
    <div class="tools">
      <button class="btn" id="btnName">Ä°sim</button>
      <button class="btn green" id="btnHelp">Komutlar</button>
      <button class="btn" id="btnTopics">7. SÄ±nÄ±f</button>
      <button class="btn" id="btnOtt">OsmanlÄ±</button>
      <button class="btn" id="btnClear">Temizle</button>
    </div>
  </div>

  <div class="wrap"><div class="chat" id="chat"></div></div>

  <div class="composer">
    <div class="inner">
      <textarea id="inp" placeholder='Bir ÅŸey yaz... (Ã¶rn: "Konu anlat: KarÄ±ÅŸÄ±mlar", "test: karÄ±ÅŸÄ±mlar", "osmanlÄ±nÄ±n 2. padiÅŸahÄ± nasÄ±l Ã¶ldÃ¼", "cumhuriyet ne zaman ilan edildi", "3 km kaÃ§ m")'></textarea>
      <button class="send" id="send">GÃ¶nder</button>
    </div>
    <div class="hintbar">
      <span class="chip" data-q="Benim adÄ±m Mehmet">Benim adÄ±mâ€¦</span>
      <span class="chip" data-q="Konu anlat: KarÄ±ÅŸÄ±mlar">Konu anlat</span>
      <span class="chip" data-q="test: karÄ±ÅŸÄ±mlar">Test</span>
      <span class="chip" data-q="osmanlÄ±nÄ±n 7. padiÅŸahÄ± kim">OsmanlÄ± kaÃ§Ä±ncÄ±</span>
      <span class="chip" data-q="osmanlÄ±nÄ±n 17. padiÅŸahÄ± nasÄ±l Ã¶ldÃ¼">OsmanlÄ± Ã¶lÃ¼m</span>
      <span class="chip" data-q="cumhuriyet ne zaman ilan edildi">Cumhuriyet</span>
      <span class="chip" data-q="12 bÃ¶lÃ¼ 3">Hesap</span>
      <span class="chip" data-q="saat kaÃ§">Saat</span>
    </div>
  </div>

<script>
(() => {
  // ---------- Storage ----------
  const store = {
    get(k,d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } },
    set(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  };

  const state = {
    name: store.get("ea_name",""),
    title: store.get("ea_title","Emir AI"),
    chat: store.get("ea_chat", []),
    lastTopic: store.get("ea_lastTopic",""),
    test: store.get("ea_test", null) // {key, i, score}
  };

  const $ = (id)=>document.getElementById(id);
  const chatEl = $("chat");
  const inp = $("inp");
  const sendBtn = $("send");

  $("brandTitle").textContent = state.title;

  const now = () => new Date().toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"});
  const today = () => new Date().toLocaleDateString("tr-TR",{weekday:"long", year:"numeric", month:"long", day:"numeric"});

  function norm(s){
    return (s||"").toLowerCase()
      .replaceAll("Ä±","i").replaceAll("ÄŸ","g").replaceAll("Ã¼","u")
      .replaceAll("ÅŸ","s").replaceAll("Ã¶","o").replaceAll("Ã§","c")
      .replace(/[?!.,"'â€™]/g," ")
      .replace(/\s+/g," ")
      .trim();
  }

  function addRow(who, text){
    const row = document.createElement("div");
    row.className = "row";

    const av = document.createElement("div");
    av.className = "avatar " + (who==="me" ? "me":"bot");
    av.textContent = who==="me" ? "S" : "AI";

    const bub = document.createElement("div");
    bub.className = "bubble";
    bub.textContent = text;

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = (who==="me" ? "Sen" : state.title) + " â€¢ " + now();
    bub.appendChild(meta);

    row.appendChild(av);
    row.appendChild(bub);
    chatEl.appendChild(row);
    chatEl.scrollTop = chatEl.scrollHeight;

    state.chat.push({who, text, t: Date.now()});
    store.set("ea_chat", state.chat.slice(-220));
  }

  function typingOn(){
    const row = document.createElement("div");
    row.className = "row";
    row.id = "typingRow";

    const av = document.createElement("div");
    av.className = "avatar bot";
    av.textContent = "AI";

    const bub = document.createElement("div");
    bub.className = "bubble";
    bub.innerHTML = `<span class="typing">YazÄ±yor <span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`;

    row.appendChild(av);
    row.appendChild(bub);
    chatEl.appendChild(row);
    chatEl.scrollTop = chatEl.scrollHeight;
  }
  function typingOff(){ const t = document.getElementById("typingRow"); if(t) t.remove(); }

  function autoResize(){
    inp.style.height = "0px";
    inp.style.height = Math.min(inp.scrollHeight, 160) + "px";
  }

  // ---------- Knowledge: 7. SÄ±nÄ±f (konu haritasÄ±) ----------
  const GRADE7 = {
    "Fen Bilimleri": [
      ["GÃ¼neÅŸ Sistemi ve Ã–tesi", "Gezegenler, tutulmalar, uzay teknolojileri, yÄ±ldÄ±zlar-galaksiler."],
      ["HÃ¼cre ve BÃ¶lÃ¼nmeler", "HÃ¼cre yapÄ±sÄ±, mitoz-mayoz, bÃ¼yÃ¼me-onarÄ±m, Ã¼reme."],
      ["Kuvvet ve Enerji", "Ä°ÅŸ-gÃ¼Ã§-enerji, sÃ¼rtÃ¼nme, enerji dÃ¶nÃ¼ÅŸÃ¼mleri."],
      ["Saf Maddeler ve KarÄ±ÅŸÄ±mlar", "Element-bileÅŸik, Ã§Ã¶zelti, ayÄ±rma yÃ¶ntemleri."],
      ["IÅŸÄ±ÄŸÄ±n Madde ile EtkileÅŸimi", "YansÄ±ma-kÄ±rÄ±lma, mercekler, renkler."],
      ["Elektrik Devreleri", "Seri-paralel devre, ampul parlaklÄ±ÄŸÄ±, devre elemanlarÄ±."]
    ],
    "Matematik": [
      ["Tam SayÄ±lar", "Ä°ÅŸaret kurallarÄ±, mutlak deÄŸer, iÅŸlemler, problemler."],
      ["Rasyonel SayÄ±lar", "Kesir-ondalÄ±k, karÅŸÄ±laÅŸtÄ±rma, iÅŸlemler."],
      ["Oran-OrantÄ±", "DoÄŸru/ters orantÄ±, problemler."],
      ["YÃ¼zdeler", "Ä°ndirim-zam, yÃ¼zde hesaplarÄ±."],
      ["Cebirsel Ä°fadeler", "Terim-katsayÄ±, parantez, sadeleÅŸtirme."],
      ["Denklemler", "Basit denklemler, problem Ã§Ã¶zme."],
      ["DoÄŸrular-AÃ§Ä±lar", "Temel geometrik iliÅŸkiler."],
      ["Ã‡okgenler", "ÃœÃ§gen-dÃ¶rtgen Ã¶zellikleri (temel)."],
      ["Veri Analizi", "Tablo-grafik, yorumlama."]
    ],
    "TÃ¼rkÃ§e": [
      ["Paragraf", "Ana fikir, yardÄ±mcÄ± fikir, konu, baÅŸlÄ±k."],
      ["SÃ¶zcÃ¼kte Anlam", "GerÃ§ek/mecaz/terim, deyim-atasÃ¶zÃ¼."],
      ["CÃ¼mlede Anlam", "Neden-sonuÃ§, amaÃ§-sonuÃ§, koÅŸul, Ã§Ä±karÄ±m."],
      ["YazÄ±m KurallarÄ±", "BÃ¼yÃ¼k harfler, birleÅŸik kelimeler, sayÄ±larÄ±n yazÄ±mÄ±."],
      ["Noktalama", "VirgÃ¼l, nokta, iki nokta, kesme, tÄ±rnak vb."],
      ["Fiilimsiler", "Ä°sim-fiil, sÄ±fat-fiil, zarf-fiil (temel)."],
      ["SÃ¶z SanatlarÄ±", "Benzetme, kiÅŸileÅŸtirme, abartma, konuÅŸturma."]
    ],
    "Sosyal Bilgiler": [
      ["Birey ve Toplum", "Hak-sorumluluk, iletiÅŸim, empati."],
      ["KÃ¼ltÃ¼r ve Miras", "TÃ¼rk-Ä°slam ve OsmanlÄ± kÃ¼ltÃ¼rÃ¼, miras."],
      ["Ä°nsanlar ve Ã‡evre", "NÃ¼fus, gÃ¶Ã§, yerleÅŸme, iklim (temel)."],
      ["Bilim-Teknoloji-Toplum", "Teknolojinin etkileri, etik."],
      ["Ãœretim-DaÄŸÄ±tÄ±m-TÃ¼ketim", "Kaynaklar, ekonomi, bilinÃ§li tÃ¼ketim."],
      ["Etkin VatandaÅŸlÄ±k", "Demokrasi, katÄ±lÄ±m, yÃ¶netim (temel)."]
    ],
    "Din KÃ¼ltÃ¼rÃ¼": [
      ["Ä°badet ve Dua", "Ä°badetin anlamÄ±, dua, ahlak iliÅŸkisi."],
      ["Ahlak", "GÃ¼zel davranÄ±ÅŸlar, sorumluluk, kul hakkÄ±."],
      ["Hz. Muhammedâ€™in Ã–rnekliÄŸi", "DoÄŸruluk, gÃ¼ven, merhamet (genel)."],
      ["Ä°slamâ€™da Bilgi", "Bilginin Ã¶nemi, doÄŸru kaynak, sorumluluk (genel)."]
    ],
    "Ä°ngilizce": [
      ["Daily Routines", "Simple Present, saatler, rutinler."],
      ["Likes / Dislikes", "Seviyorum-sevmiyorum, tercih bildirme."],
      ["Descriptions", "People/places, sÄ±fatlar."],
      ["Past Simple (temel)", "DÃ¼n ne yaptÄ±n? (basic)."],
      ["Shopping / Numbers", "Fiyat, sayÄ±, basit diyalog."]
    ]
  };

  function listTopics(){
    let out = "7. sÄ±nÄ±f konu haritasÄ± (Ã¶zet):\n";
    for(const [lesson, arr] of Object.entries(GRADE7)){
      out += `\nâ€¢ ${lesson}:\n` + arr.map((x,i)=>`  ${i+1}) ${x[0]}`).join("\n") + "\n";
    }
    out += "\nKullanÄ±m:\n- \"Konu anlat: KarÄ±ÅŸÄ±mlar\"\n- \"KarÄ±ÅŸÄ±mlar detay\"\n- \"test: karÄ±ÅŸÄ±mlar\"";
    return out.trim();
  }

  // ---------- Knowledge: Cumhuriyet ----------
  const REPUBLIC = {
    proclamation: "TÃ¼rkiye Cumhuriyeti, TBMMâ€™de 29 Ekim 1923â€™te yapÄ±lan anayasa deÄŸiÅŸikliÄŸiyle ilan edildi; Mustafa Kemal AtatÃ¼rk ilk cumhurbaÅŸkanÄ± seÃ§ildi.",
    republicDay: "29 Ekim Cumhuriyet BayramÄ± her yÄ±l 29 Ekimâ€™de kutlanÄ±r (kutlamalar 28 Ekim Ã¶ÄŸleden sonra baÅŸlayabilir)."
  };

  // ---------- Knowledge: OsmanlÄ± (kaÃ§Ä±ncÄ± + Ã¶lÃ¼m notu) ----------
  // Kaynak olarak listede aÃ§Ä±kÃ§a belirtilen notlar (killed/murdered/strangled/executed/died in exile vb.) kullanÄ±ldÄ±.
  // DiÄŸerleri iÃ§in: "saltanatÄ± Ã¶lÃ¼mÃ¼ne kadar sÃ¼rdÃ¼" gibi genel not verilir. :contentReference[oaicite:2]{index=2}
  const OTTOMAN = [
    {n:1, name:"Osman Gazi", deathNote:"SaltanatÄ± Ã¶lÃ¼mÃ¼ne kadar sÃ¼rdÃ¼."},
    {n:2, name:"Orhan Gazi", deathNote:"SaltanatÄ± Ã¶lÃ¼mÃ¼ne kadar sÃ¼rdÃ¼."},
    {n:3, name:"I. Murad (HÃ¼davendigÃ¢r)", deathNote:"Kosova SavaÅŸÄ± (1389) sonrasÄ± Ã¶ldÃ¼rÃ¼ldÃ¼/ÅŸehit edildi (savaÅŸ meydanÄ±)."},
    {n:4, name:"YÄ±ldÄ±rÄ±m Bayezid", deathNote:"Ankara SavaÅŸÄ±â€™nda esir dÃ¼ÅŸtÃ¼; AkÅŸehirâ€™de esarette Ã¶ldÃ¼ (1403)."},
    {n:5, name:"I. Mehmed (Ã‡elebi)", deathNote:"SaltanatÄ± Ã¶lÃ¼mÃ¼ne kadar sÃ¼rdÃ¼."},
    {n:6, name:"II. Murad", deathNote:"SaltanatÄ± Ã¶lÃ¼mÃ¼ne kadar sÃ¼rdÃ¼."},
    {n:7, name:"II. Mehmed (Fatih)", deathNote:"SaltanatÄ± Ã¶lÃ¼mÃ¼ne kadar sÃ¼rdÃ¼."},
    {n:8, name:"II. Bayezid", deathNote:"Tahttan indirildi; Dimetoka yakÄ±nlarÄ±nda Ã¶ldÃ¼ (1512)."},
    {n:9, name:"I. Selim (Yavuz)", deathNote:"SaltanatÄ± Ã¶lÃ¼mÃ¼ne kadar sÃ¼rdÃ¼."},
    {n:10, name:"I. SÃ¼leyman (Kanuni)", deathNote:"Szigetvar KuÅŸatmasÄ± sÄ±rasÄ±nda otaÄŸÄ±nda Ã¶ldÃ¼ (1566)."},
    {n:11, name:"II. Selim", deathNote:"SaltanatÄ± Ã¶lÃ¼mÃ¼ne kadar sÃ¼rdÃ¼."},
    {n:12, name:"III. Murad", deathNote:"SaltanatÄ± Ã¶lÃ¼mÃ¼ne kadar sÃ¼rdÃ¼."},
    {n:13, name:"III. Mehmed", deathNote:"SaltanatÄ± Ã¶lÃ¼mÃ¼ne kadar sÃ¼rdÃ¼."},
    {n:14, name:"I. Ahmed", deathNote:"SaltanatÄ± Ã¶lÃ¼mÃ¼ne kadar sÃ¼rdÃ¼."},
    {n:15, name:"I. Mustafa", deathNote:"Ä°kinci saltanatÄ± sonrasÄ± sarayda tutuldu; Ä°stanbulâ€™da Ã¶ldÃ¼ (1639)."},
    {n:16, name:"II. Osman (GenÃ§ Osman)", deathNote:"YeniÃ§eri isyanÄ±yla tahttan indirildi; Ã¶ldÃ¼rÃ¼ldÃ¼ (1622)."},
    {n:17, name:"IV. Murad", deathNote:"SaltanatÄ± Ã¶lÃ¼mÃ¼ne kadar sÃ¼rdÃ¼."},
    {n:18, name:"I. Ä°brahim", deathNote:"Tahttan indirildi; Ä°stanbulâ€™da boÄŸduruldu (1648)."},
    {n:19, name:"IV. Mehmed", deathNote:"Tahttan indirildi (1687); Edirneâ€™de Ã¶ldÃ¼ (1693)."},
    {n:20, name:"II. SÃ¼leyman", deathNote:"SaltanatÄ± Ã¶lÃ¼mÃ¼ne kadar sÃ¼rdÃ¼."},
    {n:21, name:"II. Ahmed", deathNote:"SaltanatÄ± Ã¶lÃ¼mÃ¼ne kadar sÃ¼rdÃ¼."},
    {n:22, name:"II. Mustafa", deathNote:"Edirne VakasÄ± sonrasÄ± tahttan indirildi; Ä°stanbulâ€™da Ã¶ldÃ¼ (1704)."},
    {n:23, name:"III. Ahmed", deathNote:"Patrona Halil isyanÄ± sonrasÄ± tahttan indirildi; Ã¶ldÃ¼ (1736)."},
    {n:24, name:"I. Mahmud", deathNote:"SaltanatÄ± Ã¶lÃ¼mÃ¼ne kadar sÃ¼rdÃ¼."},
    {n:25, name:"III. Osman", deathNote:"SaltanatÄ± Ã¶lÃ¼mÃ¼ne kadar sÃ¼rdÃ¼."},
    {n:26, name:"III. Mustafa", deathNote:"SaltanatÄ± Ã¶lÃ¼mÃ¼ne kadar sÃ¼rdÃ¼."},
    {n:27, name:"I. AbdÃ¼lhamid", deathNote:"SaltanatÄ± Ã¶lÃ¼mÃ¼ne kadar sÃ¼rdÃ¼."},
    {n:28, name:"III. Selim", deathNote:"Tahttan indirildi; Ä°stanbulâ€™da Ã¶ldÃ¼rÃ¼ldÃ¼ (1808)."},
    {n:29, name:"IV. Mustafa", deathNote:"Tahttan indirildi; Ä°stanbulâ€™da idam edildi (1808)."},
    {n:30, name:"II. Mahmud", deathNote:"SaltanatÄ± Ã¶lÃ¼mÃ¼ne kadar sÃ¼rdÃ¼."},
    {n:31, name:"AbdÃ¼lmecid", deathNote:"SaltanatÄ± Ã¶lÃ¼mÃ¼ne kadar sÃ¼rdÃ¼."},
    {n:32, name:"AbdÃ¼laziz", deathNote:"Tahttan indirildi; 5 gÃ¼n sonra Ã¶lÃ¼ bulundu (intihar/Ã¶ldÃ¼rÃ¼lme tartÄ±ÅŸmalÄ±)."},
    {n:33, name:"V. Murad", deathNote:"SaÄŸlÄ±k nedeniyle indirildi; Ã‡Ä±raÄŸan SarayÄ±â€™nda Ã¶ldÃ¼ (1904)."},
    {n:34, name:"II. AbdÃ¼lhamid", deathNote:"Tahttan indirildi; Beylerbeyi SarayÄ±â€™nda Ã¶ldÃ¼ (1918)."},
    {n:35, name:"V. Mehmed (ReÅŸad)", deathNote:"SaltanatÄ± Ã¶lÃ¼mÃ¼ne kadar sÃ¼rdÃ¼."},
    {n:36, name:"VI. Mehmed (Vahdeddin)", deathNote:"Saltanat kaldÄ±rÄ±ldÄ±; sÃ¼rgÃ¼nde (Sanremo, Ä°talya) Ã¶ldÃ¼ (1926)."}
  ];

  function findOttomanByOrdinal(textN){
    const m = textN.match(/(\d{1,2})\s*\.?\s*padi/);
    if(!m) return null;
    const n = parseInt(m[1],10);
    return OTTOMAN.find(x=>x.n===n) || null;
  }

  // ---------- Mini tests ----------
  const MINI_TESTS = {
    "karisimlar": [
      {q:"Homojen karÄ±ÅŸÄ±m hangisidir?", a:["Kumlu su","Tuzlu su","YaÄŸ-su"], c:1},
      {q:"Tuzlu sudan tuzu ayÄ±rma yÃ¶ntemi?", a:["SÃ¼zme","BuharlaÅŸtÄ±rma","Eleme"], c:1},
      {q:"Kumlu suyu ayÄ±rma yÃ¶ntemi?", a:["SÃ¼zme","MÄ±knatÄ±s","DamÄ±tma"], c:0},
    ],
    "elektrik": [
      {q:"Seri devrede ampul sayÄ±sÄ± artarsa parlaklÄ±k genelde?", a:["Artar","AzalÄ±r","DeÄŸiÅŸmez"], c:1},
      {q:"Paralel devrede bir ampul patlarsa diÄŸerleri?", a:["SÃ¶ner","YanmayÄ± sÃ¼rdÃ¼rÃ¼r","Hepsi patlar"], c:1},
    ],
    "osmanli": [
      {q:"Ä°stanbulâ€™u fetheden padiÅŸah?", a:["Fatih","Yavuz","Kanuni"], c:0},
      {q:"OsmanlÄ±â€™nÄ±n kurucusu?", a:["Orhan","Osman","I. Murad"], c:1},
    ]
  };

  function startTest(raw){
    const t = norm(raw);
    if(!t.startsWith("test:")) return null;
    const key = norm(t.split("test:")[1] || "").trim();

    let k=null;
    if(key.includes("karisim")) k="karisimlar";
    else if(key.includes("elektrik")) k="elektrik";
    else if(key.includes("osman")) k="osmanli";
    else return "Bu test yok. Deneyin: test: karÄ±ÅŸÄ±mlar / elektrik / osmanlÄ±";

    state.test = {key:k, i:0, score:0};
    store.set("ea_test", state.test);

    const q = MINI_TESTS[k][0];
    return `Mini test baÅŸladÄ± (${key}).\nSoru 1: ${q.q}\nA) ${q.a[0]}\nB) ${q.a[1]}\nC) ${q.a[2]}\nCevap: A/B/C`;
  }

  function answerTest(raw){
    if(!state.test) return null;
    const t = norm(raw);
    if(t === "test iptal" || t === "iptal"){
      state.test=null; store.set("ea_test", state.test);
      return "Test modunu kapattÄ±m âœ…";
    }
    const a = raw.trim().toUpperCase();
    if(!["A","B","C"].includes(a)) return `Test modundayÄ±z. Sadece A/B/C yaz.\n(Ã‡Ä±kmak iÃ§in: "test iptal")`;

    const bank = MINI_TESTS[state.test.key];
    const q = bank[state.test.i];
    const idx = {A:0,B:1,C:2}[a];

    let out = "";
    if(idx===q.c){ state.test.score++; out += "âœ… DoÄŸru!\n"; }
    else out += `âŒ YanlÄ±ÅŸ. DoÄŸru cevap: ${["A","B","C"][q.c]}\n`;

    state.test.i++;
    if(state.test.i >= bank.length){
      out += `\nTest bitti! Skor: ${state.test.score}/${bank.length}\nYeni test: "test: karÄ±ÅŸÄ±mlar / elektrik / osmanlÄ±"`;
      state.test=null; store.set("ea_test", state.test);
      return out.trim();
    }
    store.set("ea_test", state.test);
    const nq = bank[state.test.i];
    out += `Soru ${state.test.i+1}: ${nq.q}\nA) ${nq.a[0]}\nB) ${nq.a[1]}\nC) ${nq.a[2]}\nCevap: A/B/C`;
    return out.trim();
  }

  // ---------- â€œGÃ¼nlÃ¼k en sÄ±k sorularâ€ (offline FAQ seti) ----------
  function dailyFAQ(textN){
    // Basit yÃ¶nlendirme/cevaplar (offline)
    if(textN.includes("saat kac") || textN.includes("saat kaÃ§")) return `Åžu an saat: ${new Date().toLocaleTimeString("tr-TR")}`;
    if(textN.includes("bugun") && (textN.includes("gun") || textN.includes("tarih"))) return `BugÃ¼n: ${today()}`;
    if(textN.includes("nasilsin") || textN.includes("nasi gidiyor")) return "Ä°yiyim ðŸ™‚ Sen nasÄ±lsÄ±n?";
    if(textN.includes("ne yapayim") || textN.includes("ne yapalim")){
      return "3 hÄ±zlÄ± Ã¶neri:\n1) 10 dk tekrar: \"Konu anlat: ...\"\n2) Mini test: \"test: ...\"\n3) Bir hedef yaz: BugÃ¼n tek iÅŸ = (â€¦)\nHangisini seÃ§tin?";
    }
    if(textN.includes("ozetle") || textN.includes("Ã¶zetle")){
      return "Neyi Ã¶zetleyeyim? Metni buraya yapÄ±ÅŸtÄ±r veya konu baÅŸlÄ±ÄŸÄ±nÄ± yaz.";
    }
    if(textN.includes("mail") || textN.includes("e posta") || textN.includes("eposta")){
      return "E-posta yazdÄ±rmak iÃ§in: Kime + konu + amaÃ§ + ton (resmi/samimi) yaz, ben taslak Ã§Ä±karayÄ±m.";
    }
    if(textN.includes("cv") || textN.includes("Ã¶zgeÃ§miÅŸ")){
      return "CV iÃ§in: eÄŸitim + iÅŸ deneyimi + beceriler + hedef pozisyon yaz, dÃ¼zenleyeyim.";
    }
    return null;
  }

  // ---------- Math / conversions ----------
  function tryMath(raw){
    let s = raw.toLowerCase()
      .replaceAll("Ã§arpÄ±","*").replaceAll("carpi","*").replaceAll("x","*").replaceAll("Ã—","*")
      .replaceAll("artÄ±","+").replaceAll("arti","+")
      .replaceAll("eksi","-")
      .replaceAll("bÃ¶lÃ¼","/").replaceAll("bolu","/").replaceAll("Ã·","/")
      .replaceAll(",",".");
    s = s.replace(/[^0-9+\-*/().\s]/g,"").trim();
    if(!s) return null;
    if(!(/\d/.test(s) && /[+\-*/]/.test(s))) return null;
    try{
      const v = Function('"use strict";return ('+s+')')();
      if(!isFinite(v)) return "SonuÃ§ tanÄ±msÄ±z (0â€™a bÃ¶lme olabilir).";
      const pretty = (Math.abs(v)%1===0) ? String(v) : String(Number(v.toFixed(6)));
      return `SonuÃ§: ${pretty}\nÄ°ÅŸlem: ${s}`;
    }catch{ return null; }
  }

  function unitConvert(textN){
    // km->m, m->cm, kg->g, l->ml
    const m1 = textN.match(/(\d+(?:\.\d+)?)\s*km\s*(kac|kaÃ§)?\s*m/);
    if(m1) return `${m1[1]} km = ${Number(m1[1])*1000} m`;
    const m2 = textN.match(/(\d+(?:\.\d+)?)\s*m\s*(kac|kaÃ§)?\s*cm/);
    if(m2) return `${m2[1]} m = ${Number(m2[1])*100} cm`;
    const m3 = textN.match(/(\d+(?:\.\d+)?)\s*kg\s*(kac|kaÃ§)?\s*g/);
    if(m3) return `${m3[1]} kg = ${Number(m3[1])*1000} g`;
    const m4 = textN.match(/(\d+(?:\.\d+)?)\s*l\s*(kac|kaÃ§)?\s*ml/);
    if(m4) return `${m4[1]} L = ${Number(m4[1])*1000} mL`;
    return null;
  }

  // ---------- Topic explain ----------
  function explainTopic(raw){
    const t = norm(raw);

    if(t.includes("7 sinif") && t.includes("konu")) return listTopics();

    if(t.startsWith("konu anlat:")){
      const topic = norm(raw.split(":")[1] || "").trim();
      state.lastTopic = topic; store.set("ea_lastTopic", state.lastTopic);

      // basit eÅŸleÅŸtirme
      if(topic.includes("elektrik")){
        return `Elektrik Devreleri (Ã¶zet):
â€¢ Devre elemanlarÄ±: pil, ampul, anahtar, kablo.
â€¢ KapalÄ± devre: yanar. AÃ§Ä±k devre: yanmaz.
â€¢ Seri devre: tek yol; biri Ã§Ä±karsa devre bozulur.
â€¢ Paralel devre: kollar baÄŸÄ±msÄ±z Ã§alÄ±ÅŸÄ±r.
Ä°stersen: "Elektrik devreleri detay" veya "test: elektrik"`;
      }
      if(topic.includes("karisim")){
        return `Saf Maddeler ve KarÄ±ÅŸÄ±mlar (Ã¶zet):
â€¢ Saf madde: tek tÃ¼r tanecik (element/bileÅŸik).
â€¢ KarÄ±ÅŸÄ±m: homojen (tuzlu su) / heterojen (kumlu su).
â€¢ AyÄ±rma: sÃ¼zme, eleme, mÄ±knatÄ±s, buharlaÅŸtÄ±rma.
Ä°stersen: "KarÄ±ÅŸÄ±mlar detay" veya "test: karÄ±ÅŸÄ±mlar"`;
      }
      if(topic.includes("mitoz") || topic.includes("mayoz") || topic.includes("bolunme") || topic.includes("bÃ¶lÃ¼nme")){
        return `HÃ¼cre BÃ¶lÃ¼nmeleri (Ã¶zet):
â€¢ Mitoz: 1â†’2 aynÄ± hÃ¼cre, bÃ¼yÃ¼me-onarÄ±m, kromozom sayÄ±sÄ± korunur.
â€¢ Mayoz: 1â†’4 farklÄ± hÃ¼cre, Ã¼reme, kromozom sayÄ±sÄ± yarÄ±ya iner.`;
      }

      return `Bu konuyu aÃ§abilirim ama baÅŸlÄ±ÄŸÄ± biraz daha net yaz:
Ã–rn: "Konu anlat: KarÄ±ÅŸÄ±mlar" / "Konu anlat: Elektrik devreleri" / "Konu anlat: Mitoz-Mayoz"`;
    }

    if(t.endsWith("detay") || t.includes(" detay")){
      const base = t.replace("detay","").trim() || state.lastTopic;
      if(!base) return null;

      if(base.includes("elektrik")){
        return `Elektrik Devreleri (detay):
â€¢ Seri devrede ampul sayÄ±sÄ± artarsa parlaklÄ±k genelde azalÄ±r.
â€¢ Paralel devrede kollar baÄŸÄ±msÄ±zdÄ±r; bir ampul patlasa diÄŸerleri yanabilir.
â€¢ Ampul parlaklÄ±ÄŸÄ±: pil sayÄ±sÄ±, baÄŸlanma ÅŸekli, ampul sayÄ±sÄ± gibi etkenlere baÄŸlÄ±.
Ä°stersen 3 soru sorayÄ±m mÄ±? (evet/hayÄ±r)`;
      }
      if(base.includes("karisim")){
        return `KarÄ±ÅŸÄ±mlar (detay):
â€¢ Homojen (Ã§Ã¶zelti): Ã§Ã¶zÃ¼nen + Ã§Ã¶zÃ¼cÃ¼.
â€¢ Heterojen: fazlar gÃ¶rÃ¼lÃ¼r (yaÄŸ-su).
AyÄ±rma:
â€¢ SÃ¼zme (katÄ±+sÄ±vÄ±), Eleme (katÄ±+katÄ±), MÄ±knatÄ±s, BuharlaÅŸtÄ±rma.
Ä°stersen 5 soru: "test: karÄ±ÅŸÄ±mlar"`;
      }
    }

    return null;
  }

  // ---------- Ottoman answers ----------
  function answerOttoman(raw){
    const t = norm(raw);
    if(!(t.includes("osmanli") || t.includes("osmanlÄ±"))) return null;

    if(t.includes("tum") || t.includes("hepsi") || t.includes("liste")){
      return "OsmanlÄ± padiÅŸahlarÄ± (1â†’36):\n" + OTTOMAN.map(x=>`${x.n}) ${x.name}`).join("\n");
    }

    const ord = findOttomanByOrdinal(t);
    if(ord){
      if(t.includes("nasil oldu") || t.includes("nasÄ±l Ã¶ldÃ¼") || t.includes("oldu") || t.includes("Ã¶ldÃ¼")){
        return `OsmanlÄ±'nÄ±n ${ord.n}. padiÅŸahÄ±: ${ord.name}\nÃ–lÃ¼m notu: ${ord.deathNote}`;
      }
      return `OsmanlÄ±'nÄ±n ${ord.n}. padiÅŸahÄ±: ${ord.name}`;
    }

    return "OsmanlÄ± iÃ§in Ã¶rnek:\nâ€¢ \"osmanlÄ±nÄ±n 7. padiÅŸahÄ± kim\"\nâ€¢ \"osmanlÄ±nÄ±n 3. padiÅŸahÄ± nasÄ±l Ã¶ldÃ¼\"\nâ€¢ \"osmanlÄ±nÄ±n tÃ¼m padiÅŸahlarÄ±\"";
  }

  // ---------- Cumhuriyet answers ----------
  function answerRepublic(t){
    if(t.includes("cumhuriyet") && (t.includes("ne zaman") || t.includes("ilan"))){
      return REPUBLIC.proclamation + "\n\nCumhuriyet BayramÄ±: " + REPUBLIC.republicDay;
    }
    if(t.includes("29 ekim")){
      return REPUBLIC.republicDay + "\n" + "Cumhuriyetin ilanÄ±: 29 Ekim 1923.";
    }
    return null;
  }

  // ---------- Name ----------
  function setNameFromText(raw){
    const m = raw.match(/benim ad[Ä±i]m\s+(.+)/i);
    if(!m || !m[1]) return null;
    state.name = m[1].trim().replace(/[.!?]/g,"");
    store.set("ea_name", state.name);
    return `Tamam ${state.name} ðŸ˜Ž Ä°smini kaydettim.`;
  }

  // ---------- Help ----------
  function helpText(){
    return `Komutlar:
â€¢ ${"`Benim adÄ±m ...`"} â†’ isim kaydeder
â€¢ ${"`7. sÄ±nÄ±f konular`"} â†’ tÃ¼m ders konu haritasÄ±
â€¢ ${"`Konu anlat: ...`"} / ${"`... detay`"} â†’ konu anlatÄ±m
â€¢ ${"`test: karÄ±ÅŸÄ±mlar / elektrik / osmanlÄ±`"} â†’ mini test
â€¢ ${"`osmanlÄ±nÄ±n 7. padiÅŸahÄ± kim`"} / ${"`... nasÄ±l Ã¶ldÃ¼`"} â†’ tarih
â€¢ ${"`cumhuriyet ne zaman ilan edildi`"} â†’ Cumhuriyet bilgisi
â€¢ Hesap: ${"`12 bÃ¶lÃ¼ 3`"} / ${"`7*8`"} / ${"`(10+2)/3`"}
â€¢ Birim: ${"`3 km kaÃ§ m`"} / ${"`2 kg kaÃ§ g`"} / ${"`1.5 L kaÃ§ ml`"}`;
  }

  // ---------- Smart answer ----------
  function smartAnswer(raw){
    const t = norm(raw);

    const nameAns = setNameFromText(raw);
    if(nameAns) return nameAns;

    const testAns = answerTest(raw);
    if(testAns) return testAns;

    const testStart = startTest(raw);
    if(testStart) return testStart;

    const ott = answerOttoman(raw);
    if(ott) return ott;

    const rep = answerRepublic(t);
    if(rep) return rep;

    const topic = explainTopic(raw);
    if(topic) return topic;

    const conv = unitConvert(t);
    if(conv) return conv;

    const math = tryMath(raw);
    if(math) return math;

    const faq = dailyFAQ(t);
    if(faq) return faq;

    // kÃ¼Ã§Ã¼k â€œzekileÅŸtirmeâ€: ders kelimelerini yakala
    if(t.includes("mitoz")) return "Mitoz: bÃ¼yÃ¼me-onarÄ±m; 1 hÃ¼cre â†’ 2 aynÄ± hÃ¼cre; kromozom sayÄ±sÄ± deÄŸiÅŸmez.";
    if(t.includes("mayoz")) return "Mayoz: Ã¼reme ana hÃ¼crelerinde; 1 hÃ¼cre â†’ 4 farklÄ± hÃ¼cre; kromozom sayÄ±sÄ± yarÄ±ya iner.";
    if(t.includes("yuzde") || t.includes("yÃ¼zde")) return "YÃ¼zde iÃ§in Ã¶rnek yaz: \"120â€™nin %20â€™si\" gibi. Ben hesaplayayÄ±m.";
    if(t.includes("paragraf") || t.includes("ana fikir")) return "Paragrafta ana fikir genelde yazarÄ±n vermek istediÄŸi mesajdÄ±r. Metni yapÄ±ÅŸtÄ±r, ana fikri bulayÄ±m.";

    // fallback
    const nick = state.name ? state.name : "kanka";
    return `AnladÄ±m ${nick}. Bunu iki ÅŸekilde Ã§Ã¶zebiliriz:
1) Ders: "Konu anlat: ..." yaz
2) GÃ¼nlÃ¼k/hesap: soruyu net yaz (Ã¶rn: "3 km kaÃ§ m", "cumhuriyet ne zaman ilan edildi")
Ä°stersen sorunu aynen tekrar yaz, ben doÄŸru kategoriye sokayÄ±m.`;
  }

  // ---------- UI actions ----------
  function restore(){
    chatEl.innerHTML = "";
    for(const m of state.chat.slice(-90)){
      addRow(m.who, m.text);
    }
    // restore() addRow zaten kayda tekrar yazar; bunu Ã¶nlemek iÃ§in:
    state.chat = store.get("ea_chat", []);
    store.set("ea_chat", state.chat);

    if(state.chat.length === 0){
      addRow("bot",
`Selam! Ben ${state.title} ðŸ˜Ž
â€¢ 7. sÄ±nÄ±f konu anlatÄ±m + test
â€¢ OsmanlÄ±: kaÃ§Ä±ncÄ± padiÅŸah + (listede geÃ§en) Ã¶lÃ¼m notu
â€¢ Cumhuriyet: temel bilgiler
â€¢ GÃ¼nlÃ¼k: saat/tarih/hesap/birim dÃ¶nÃ¼ÅŸÃ¼m

Denemek iÃ§in:
- "Benim adÄ±m Mehmet"
- "7. sÄ±nÄ±f konular"
- "Konu anlat: KarÄ±ÅŸÄ±mlar"
- "test: osmanlÄ±"
- "osmanlÄ±nÄ±n 3. padiÅŸahÄ± nasÄ±l Ã¶ldÃ¼"
- "cumhuriyet ne zaman ilan edildi"`);
    }
  }

  function send(){
    const text = inp.value.trim();
    if(!text) return;
    inp.value = ""; autoResize();
    sendBtn.disabled = true;

    addRow("me", text);
    typingOn();

    setTimeout(() => {
      typingOff();
      addRow("bot", smartAnswer(text));
      sendBtn.disabled = false;
      inp.focus();
    }, 260);
  }

  $("btnHelp").onclick = () => addRow("bot", helpText());
  $("btnTopics").onclick = () => addRow("bot", listTopics());
  $("btnOtt").onclick = () => addRow("bot", "OsmanlÄ± hÄ±zlÄ± komutlar:\nâ€¢ \"osmanlÄ±nÄ±n tÃ¼m padiÅŸahlarÄ±\"\nâ€¢ \"osmanlÄ±nÄ±n 7. padiÅŸahÄ± kim\"\nâ€¢ \"osmanlÄ±nÄ±n 17. padiÅŸahÄ± nasÄ±l Ã¶ldÃ¼\"");
  $("btnClear").onclick = () => {
    if(!confirm("Sohbeti temizleyeyim mi?")) return;
    state.chat = [];
    store.set("ea_chat", state.chat);
    restore();
  };
  $("btnName").onclick = () => {
    const n = prompt("AdÄ±n ne? (Ã–rn: Mehmet)", state.name || "");
    if(n === null) return;
    state.name = (n||"").trim();
    store.set("ea_name", state.name);
    addRow("bot", state.name ? `Tamam ${state.name} ðŸ™‚` : "Ä°sim temizlendi.");
  };

  document.querySelectorAll("[data-q]").forEach(ch => {
    ch.addEventListener("click", () => {
      inp.value = ch.getAttribute("data-q");
      autoResize(); inp.focus();
    });
  });

  sendBtn.onclick = send;
  inp.addEventListener("input", autoResize);
  inp.addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(); } });

  restore();
  autoResize();
})();
</script>
</body>
</html>
